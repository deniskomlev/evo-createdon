//<?php/** * CreatedOn plugin for MODx Evolution *  * Allows to modify document creation date within template variable. *  * System events: * OnDocFormRender, OnDocFormSave *  * Plugin configuration: * &tvid=Template var ID;int; *  * @version 1.1 * @author  Denis Komlev <deniskomlev@hotmail.com> */$e =& $modx->event;$tvid = (int) $e->params['tvid'];  // ID of template variable$contentid = $e->params['id'];     // ID of edited document/** * Handle the 'OnDocFormSave' event. * Updating of the document creation date with the value passed by  * template variable. */if ($e->name == 'OnDocFormSave'){    // Get the template variable value.    $tvvalue = isset($_POST['tv'.$tvid]) ? trim($_POST['tv'.$tvid]) : null;    // Convert template variable value to timestamp.    $timestamp = strtotime($tvvalue);    // If correct timestamp is received, update the document creation date     // in database.    if ($timestamp) {        $query = 'UPDATE '.$modx->getFullTableName('site_content')               . ' SET `createdon` = '.$timestamp.' WHERE `id` = '.$contentid;        $result = $modx->db->query($query);        if (!$result) {            $modx->logEvent(5, 3,                'Unable to modify creation date for document '.$contentid,                'CreatedOnTV'            );        }    }}/** * Handle the 'OnDocFormRender' event. * Filling of the the empty template variable box with the document  * creation date. */if ($e->name == 'OnDocFormRender'){    if (!$contentid) {        // If the document is new, no further actions are necessary.        return;    }    // Get the document creation date saved in content table.    $res = $modx->db->select(        'createdon',        $modx->getFullTableName('site_content'),        'id='.$contentid    );    if ($modx->db->getRecordCount($res)) {        $createdon = $modx->db->getValue($res);    }    else {        // Stop here if we can't receive the creation date for any reason.        return;    }    // Select date displaying format based on MODx settings.    switch ($modx->config['datetime_format']) {        case 'mm/dd/YYYY':            $date_format = 'm/d/Y';            break;        case 'YYYY/mm/dd':            $date_format = 'Y/m/d';            break;        default:            $date_format = 'd-m-Y';    }    $tvvalue = date("$date_format H:i:s", $createdon);    // Prepare and print the javascript code.    $output = '        <script type="text/javascript">            var tvfield = document.getElementById("tv'.$tvid.'");            if (tvfield) {                var tvvalue = tvfield.value;                if (!tvvalue) tvfield.value = "'.$tvvalue.'";            }        </script>    ';    $e->output($output."\n");}